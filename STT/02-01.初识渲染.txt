02-01.Vulkan-初识渲染

好，各位同学，大家好呃，这节课开始呢，我们进入到vulkan的学习，那首先呢，我们用第一节课来初识一下，渲染这门技术。
OK，那么如何理解渲染呢？
我们可以看啊，左边这幅图片就是经过渲染的算法而得到的一张非常精美的图片，那么它怎么来的呢？
那么我们首先得先把渲染定义一下啊。
那这个渲染的概念啊，其实是实时渲染的概念啊，实时渲染的概念，把计算机当中的模型数据经过一系列称为管线的图形程序加工。
最终呈现预想风格图片的过程。
这里面首先有一个管线的概念啊，什么是管线呢？
等一会给大家讲解，那么最终呈现预想风格图片啊，比如说啊，有的人可以把它做成卡通渲染，有的人把它做成像素风，有的人把它做成写实风啊，那么都是不一样的。
那么也会考验游戏引擎相关的算法，那么接下来呢，我们把渲染啊，进行分类，首先是实时渲染，也就是我们本系列课程的重点讲解。
通常用于游戏，讲究的是速度，兼顾的是画质啊，我这说的兼顾呢，不是说它的画质会比较弱，而现反而说啊，现在这个实时渲染呢，它的画质是非常强的，只不过我们更偏向于速度。
比如说呢，35帧每秒啊，已经不算太高的帧率，但是呢，也是不错的啊，能够交互起来那么实时渲染呢，是有利于交互性高的场景。
比如说我们经常玩的4s啊，好那么接下来第二个分类是离线渲染，离线渲染呢，通常用于影片的渲染，精美图片的渲染，比如说我们家庭装修这种效果图。
它讲究的是画质算法，非常复杂啊，比如光线追踪啊，这种就是离线渲染，那么通常啊，像迪士尼这种电影制片厂啊，经常会使用离线渲染的方法渲染电影里面的每一帧。
这样的话呢，画面就非常的精美，也非常的写实OK。
那么接下来呢？
我们看一下渲染这件事里面啊，就有一个叫做场景的东西啊，我们通常在程序里也经常见到啊，很多游戏引擎啊，叫same scene对吧？
那么，构成一个场景，它包到底包含哪些关键的元素呢？
首先要有一个坐标系，尤其是世界坐标系，什么是世界坐标系呢？
所有物体，光源，相机等等都要放到这个坐标系当中啊，它是整个大千世界，整个游戏世界里面啊，最不动的那个点啊，零零零点。
原点OK那么有了坐标系之后啊，我们还得要有物体对吧啊，有小人啊，有车子呀，飞机呀，有房子呀什么的都是物体有了之后呢，我们还得有一台摄像机对吧，否则我怎么知道从哪里要看这个世界呢？
其实摄像机呢，就是我们人的眼睛啊，它决定了我们观察者在场景当中的位置，以及我们看向的方向。
那么当然也会决定一些摄像机的参数啊，比如焦距啊，视张角大小那么什么，什么叫视张角大小呢？
其实是指啊，就我们想象眼睛单开的这个角度啊，其实就是视张角大小了。
我们眯着眼睛看世界和睁大眼睛看世界，感觉是不一样的。
OK，接下来我们介绍一个概念是光栅化啊！
rest rasterization这个概念非常重要，我们看怎么去理解屏幕啊？
其实我们计算机的屏幕像左边这幅图所示，都是由一堆发光的点所构成啊！
发光的栅格所构成。
那么，由于屏幕的分辨率特别的高，有很多很多的栅格在里面，那么我们的肉眼就分别不出来，这些栅格点了啊，那每一个栅格点呢，我们都可以认为啊，是拥有红绿蓝三种小灯啊，这一个小格里面就有三盏小灯，我们这么去理解它。
那么，这三盏小灯呢？
它们按照不同的亮度亮起来，它们混合在一块的光发出来之后，那个颜色啊，就是我们看到的大千世界的各种各样的颜色了啊。
也就是说，把红绿蓝三种光不同的比例混合，就可以得到所有的颜色OK，这就是通常我们说的rgb啊rgb，那么接下来光栅化啊。
包山画是什么意思呢？
经过计算机对数模型数据的处理之后啊，决定啊，点亮屏幕上哪些像素？
就比如这个屏幕上，我们是决定点亮这一堆红色的像素。
那么，具体每个像素上，它的红绿蓝这三盏小灯啊，比如这个像素，它到底红绿蓝都该多亮的，比如红色特别亮，蓝色特别弱，对吧？
呃，绿色特别亮啊，蓝色特别亮，红色特别弱等等。
那么，这个决定的过程就叫光栅化啊，就是将计算机当中的模型经过一系列的啊，管线的渲染，最终决定了需要渲染哪些像素都渲染什么颜色，这样一个过程就是光栅化。
OK，那么了解了这些基础常识之后啊，我们要看一看渲染管线啊，渲染管线呢，可以是说我们作为渲染程序员，或者是说图形学从业者必备的一个啊，基础当中的一个重要知识啊，rendering pipeline。
那为什么叫管线呢啊？
它跟这个管子有什么关系呢？
我们看一下啊，这个管线呀，它肯定起始于顶点数据啊，你没数据啊，那接下来玩什么呢？
对吧？
有了顶点数据之后啊，它会被送入这个过程，先经历了第一个操作，叫三维变换。
然后三维变换后的数据又会被送入图源装备当中进行处理，这一步骤出来的数据又会被送入剪裁剔除，然后这边再出来的数据会被送入片源着色，这边再出来的数据会被送入混合与测试。
最终这里边出来的数据就去光栅化了啊，就被点亮到屏幕上，这么个意思，所以说大家看啊，从这一堆顶点数据啊，就好像是一坨水，它首先进到这里面诶，被加工了，又跑到这被加工了，又跑到这被加工了啊，每一步骤呢，都是用的上一步的数据。
所以说很像一条一条管道啊，它从管道一头走到另外一头，哎，我就成熟了啊，就变成了颜色，对吧？
OK，先看看顶点数据。
在计算机图形学当中啊，我们到底如何表达这些模型数据的呢？
当然，所有的模型啊都是以三角形为基本单位，我们看到的所有的山呐，水呀，汽车呀，马路啊，在所有的图形学当中的东西啊，都是以三角形面片为基本单位的。
那每个三角形呢？
有三个顶点，那每个顶点东优都拥有其属性，那我们怎么理解这个属性呃？
比如坐标就是它的属性啊，每一个顶点都有自己的坐标。
三个顶点构成一个三角形，连接下来就可以是吧？
当然哪个顶点还会有其他的属性啊？
比如说它有颜色属性啊，有法线属性啊等等啊，那么为什么在顶点上会有这么多的属性呢啊？
这个问题就很有意思，我们肯定在后面的课程当中做解答啊，这是跟差值相关的。
OK，那么接下来是三角形的表达啊，那么比如说我们有三个顶点，我们给它取个名字叫ABC，然后呢，我们给它进行编号啊，我们我们给每一个顶点呢，都给一个索引值啊a，你是第零号b，你是第一号c，是你是第二号。
当然ABC也可以变成啊c，你是第零号是吧？
b，你是第一号a，你是第二号都可以，我们在这是这么编的，我们为什么要给顶点编号呢？
那是因为啊，我们在计算机当中，哎，计算机肯定不像我们人一样能理解这些事，对吧？
它是靠数据来理解的。
你们想啊，我们首先拿到了，比如说是ABC了，比如说我们拿到了100个顶点，每一个顶点呢，都是一组xyz值，也就是坐标值，对吧？
一个顶点有三个坐标嘛xyz，然后呢？
这100个顶点我们全都一口气给到了呃，这个显卡。
说你画了香港，说我画什么呀？
那我都不知道这100个顶点谁和谁之间组成了一个什么三角形，对吧？
你得告诉我呀，唉，这边的话呢，我们就可以告诉他了，说这样啊，那首先呢，我把输给你的这100个顶点啊。
每个都编一个号啊，从零号编到99号对吧？
这是100个点，然后呢？
呃，我再告诉你呃，哪三个点构成了一个三角形啊？
就是说哪三个顶点为一组对吧？
比如说呃零一二。
构成一个三角形诶，他就知道了啊，我就把这三个顶点取出来诶，把它一连线，那这三个顶点就构成一个三角形了，然后我再告诉他说呃，十一十五十七啊，这三个给我构成一个三角形。
好，那么我把所有的这一系列构成方案告诉他，那这样的话gpu就知道了啊，原来你给我的是100个三一百个点，是这么来构成三角形的呀OK，那么这个就是索引的力量啊，索引所以说呢，在计算机当中啊，对于一个3d模型来讲啊，它的顶点数据。
就是由一堆的这样一个呃顶点，还有它的各自属性以及它的索引，还有索引构成三角形的一系列方案，而构成的这就是顶点数据。
好，那么我们看第二个步骤啊，唉，我们这儿好像再讲一下啊，渲染管线，刚才给大家讲过了啊，为什么叫管线？
是因为它是从头到尾一个接着一个去处理那数据被从这丢到这丢到这丢到这再丢到这是吧，最终渲染屏幕上，所以很像一条管子。
好，我们再看一下三维变换啊，我们思考一个问题啊，现在假设我们有一个很简单的三角形哎，它就在平就在一个世界坐标系当中啊，歪歪斜斜的，这样子飘在那。
那么，我们从一个角度去看它，我们看到的屏幕上的肯定是一个图片，对吧？
一个已经被光山画后的一张图啊，那么请问它是怎么投到屏幕上的呢？
啊，那这就涉及到涉及到三维变换了，三维变换呢？
它在业界存在所谓的MVP变换m变换是model变换。
这里有一个思想上的小技巧，或者说小小坑吧，那很多同学他不知道这个猫道举阵是用来干嘛的呢啊，我们可以这么去理解这件事，当你去建模的时候啊，我们通常会用一些三维建模的软件啊，比如说3d max。
那么，在建模当初啊，你在这个模型建立的过程当中吧呃，都是以它软件当中的那个世界坐标系原点为原点而进行的，对吧？
那么你导出这个模型之后呢？
这个模型上面所有的顶点数据是不是都是以原点这个世界坐标系为原点？
来进行建模的来进行描述的呀好，那么我导到我游戏里面之后啊，我拿到的这些数据就相当于我这个小圆哎，它其实是放到了我整个世界坐标系的终点，上面的一副样子。
但是我想呃，这个这个圆我不想放到世界坐标系的终点啊，我读进这个模型来之后啊，我想把它放到这个呃x=500 y=500 z=500这个位置，我想把它放那去，怎么放呢？
就是通过这个模型式，模型变换来做的啊。
那么，其实模型变换就是将啊，我们的这些模型啊，进行平移啊，缩放旋转这些操作，所以叫模型变换啊，第二个是视图变换就是vu啊vu。
那么view变换的话，它是干嘛呢？
它是将啊这些模型啊，就是已经变换到世界坐标系当中的这个模型啊，已经被移动平移平移旋转拉伸完毕的这些模型啊，投射到摄像机坐标系当中。
或者说变换到摄像机坐标系当中，那么什么是摄像机坐标系呢？
这个一会我们会有动画演示三投影变换啊，就是projection变换，那么这个projection的变换呢，它是将已经变到了这个摄像机坐标系当中的这一堆物体。
啊，投射到一个平面上，进而光沙化的这么一个玩意啊，这么一个过程好，我们接下来啊，通过动画好好看一看啊，唉，我们现在在玛雅当中啊，在3d max当中，我们建了这么个圆，是不是建了这么个圆之后呢？
我们现在唉，在我们的游戏里面把它导进来了，刚导进来的时候，这个圆是不是还是牢牢的，死死的就是？
呃，长在这个位置上对吧？
好，那么我们先把它移到这边去，怎么移呢？
我们首先用模型变换啊，当然这放了个摄像机啊，我们首先用模型变换一变换，唉，就把它变到这来了。
啊，编出来之后呢？
我们再接下来一步是什么呀？
我们是不是要最终的目的是想投射到这个摄像机的平面上，对吧？
那最简单的方案是什么？
哎，我从这个摄像机上。
我建立一个坐标系，行不行？
哎，大家也不用管我怎么建立的啊？
是用什么手段建立的？
什么数学方法？
我们先不用看，主要是做知识梳理。
我们在这建一个坐标系当中，坐标系之后呢？
我只要把这个物体啊，它都有自己的坐标是吧？
从世界坐标系当中的坐标变换到我摄像机坐标系当中的坐标。
是不是就更简单了，把这个问题更进一步简化了，好，我试试看诶，我就把它变化进来了，来这样它当前的坐标就是在我这个小坐标系当中的坐标，以这个为原点啊，它诞生了它的新的坐标。
然后呢，我再把它呀哎，你看这样的话呢，我的这个屏幕就可以放到这个z轴上了，对吧？
与z轴垂直的这么一个平面啊，这里。
那么我只要把它投到这个平面上，是不是就完成了这一步的变换啊？
OK，那么呃，具体的算法的话，我们后面才做讲解啊。
接下来我们看一下图源装配assembly什么是图源装配啊，那么在图形的世界里面，一个三角形，一条直线，这种跟点有几何关系的东西，我们称为图源。
啊，那么图元的构成，比如说如上面所讲啊呃，那么三角形是有三个索引，直线是有两个索引，对吧？
两个点构成三角形，三个点。
此时呢，我们已经把这一堆点都通过上刚才讲的那个变换，是不是已经变到一个平面上了？
对吧？
变到平面上之后呢？
我们把变换后的顶点根据索引的顺序组成三角形啊，直线啊等图圆的这么一个过程，就叫图元装配。
我们从用图来表达一下啊好，我们看这一堆顶点啊，这一堆顶点呢，一开始是在三维世界当中的点坐标啊，我我那时候也不用管谁和谁构成一个三角形什么的，我那时候不关心，我只是想把这一堆顶点的坐标啊，通过MVP变换哎，把它变到一个平面上。
那么，这个平面哎，就是这个平面，那就是我们当前的这个平面好，现在这几个点都变过来了，而且而且上面都有自己的索引编号啊，那么我们再看一看接下来图源装配就开始考虑了啊，说这一步啊，我想要开始呃思考哪些？
点构成三角形，哪些点构成直线了好？
那么告诉你零四三构成三角形，一二构成直线诶，就连起来了，对吧？
连起来之后大家会发现啊，这形成了一个包围面积是吧？
这个区域就是。
就是这个三角形要着色的区域，这条线上就是这根直线要着色的区域啊，好那么图源装配这一步啊，其实就是把变换后的顶点，根据刚才我们说的索引的顺序构成三角形，或者构成直线，这种基础图源的这么一个过程。
那么，接下来是剪裁和剔除啊？
剪裁和剔除的话就很有意思了，我们看一下剪裁是把视口外面无法显示的图源诶图源对吧？
是刚才刚讲的给剪裁掉，加快后续步骤的这么一个渲染的效率。
啊，那么当然，我检测的越多，我肯定后面剩下东西越少，我的速度会加快啊，那么剔除将背面朝向我们的三角形剔除，唉，三角形还有正面和反面这一说吗？
其实是有的啊，我们看一下，现在我们通过图形装配得到这些三角形和线，这是我们的视口啊，就是我们能看到的这个区域，是我们的视口。
然后呢？
是否外面的先剔除掉，然后呢？
我们再看一下，把背背面啊，背面朝向我们的三角形给剔除掉诶，这个就剔除掉了，来我们再看一下什么是背面？
这个我们称之为我们假设哈，我们做一个规定啊，这个是顺时针啊，这个是逆时针，我们现在假设呃，让顺时针。
这样一个连接的方式诶，说到这里是不是又有同学迷惑了？
什么叫连接方式啊？
我们是不是之前给出过索引啊啊零一二构成一个三角形？
那如果零二一的话呢，是不是它的连接方式就不一样对吧？
所以说是按照顺序的，零号连到一号，一号连到二号，二号连到零号啊，它所以说每个三角形都是有这样一个连接顺序的，我们现在假设这样去走的是一个正面，而这样走的三角形是背对我们的。
那么，背对我们的就会被剔除掉okay？
这是我们的剔除，最后是着色着色的话呢，片源啊，我们先定一下片源，片源与像素不同啊，大家很长时间以来都以为片源是跟像素是一个意思啊，片源着色不就是把像素点亮的时候点成颜色吗？
啊，不是这样。
片源与像素不一样，是以每个图源细分为单位的啊，如果只有一个三角形，那片源就等于像素，那就是像我们刚才那张呃讲光山话的时候，那个红色三角形一样，就是我全全篇就一个三角形。
那么其实它的片源就跟像素是一样，那你看啊，如果有两个重叠部分的三角形怎么办啊啊？
就比如说啊，我们我们看一下呃，就比如说吧，有两个三角形，它们中中间有重合的那一部分，那重合那一部分的像素点。
那就应该各自属于各自啊，对怎么去理解呢？
诶，怎么去理解呢？
呃，你看我现在先把我现在就像画家画画一样啊，画家画画怎么画啊？
是不是要先把诶背景画好，在背景画完之后呢？
在前面再画一下车车画完之后在车前面再画个人对吧？
那么是一层层来的啊？
那同样一个像素点，被画了几次呢，背景先画了一次，然后车又给这个像素点又画了一次着色，最后人又画了一次，对吧？
三次着色呀啊，三次着色呀，那么呃，人在这个像素点上的颜色是属于人的偏圆。
车在这个像素点上的颜色是车的片源啊，那么同样的道理对吧？
呃，两个三角形如果重叠了，那么各自都是拥有各自在这个像素点上的片源啊，这是片源的意思。
好片源着色，什么意思啊？
针对每个片源计算，它输出颜色的过程称为着色，就是shading ok，非常简单。
那么接下来就是混合与测试了啊，混合啊，比如说有透明啊，这种效果对吧？
呃，两个物体，两个三角形重叠在一起，前面的是半透明，后面的是一个实体。
那么请问它俩怎么做一次混合呢？
这个就是一个混合的过程测试啊，如果前面的三角形是一个实体，后面的三角形也是一个实心的，那么前面肯定要挡在后面嘛，对不对？
那如果说我把我先画了前面的三角形，再画后面的三角形的话。
唉，大家看啊，就刚才我们讲的那个画家的案例，是不是你先画了背景再画了车？
那如果我先画了车再画了背景的话，是不是背景会盖住车呀？
但实际上背景离我们远，应该是车盖住背景，所以说呢，在这边就有一个测试的一个过程啊，到底谁在前谁在后谁覆盖谁啊？
就是在测试这一步完成的。
okay，那么讲到这里。
我们就基本上给大家梳理了一遍啊，这个图形学当中的东西啊，渲染当中的一些基础概念，当然对于渲染管线啊这一部分啊，也不是全部，中间还有很多啊，比如说consolidation阶段啊，像什么geometry啊，computer shading等等很多东西。
是吧，我们会在后面慢慢的去展开，让大家先有感性的认知OK，那我们这节课先到这里。

