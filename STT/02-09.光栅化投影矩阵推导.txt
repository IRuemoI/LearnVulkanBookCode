02-09.Vulkan-光栅化投影矩阵推导

光栅画知识当中的投影矩阵，我们先看一下，我们面临着什么问题啊？
当图中的三个顶点啊，已经转换到了摄像机坐标系里面的时候啊，假设这个就是摄像机坐标法，我们要把点投射到画布上。
就是这样，然后形成二维坐标点对吧？
你形成二维坐标点，你可能在屏幕上把这个三角形给我画出来嘛，那么我们能不能给一个矩阵啊，一个四×4矩阵？
乘以每一个顶点得到它们的xy坐标。
其实是可以的啊，我们这节课就是解决这个问题。
首先解释一下ndc坐标，我们知道啊，在屏幕硬件当中啊，多种多样的长宽比啊，不一定，你看有的屏幕是。
这种呃带鱼屏啊，很宽，有的屏幕呢，是那种很细粒度的啊，它的那个呃像素小，然后密度很高啊，有的呢很差，比如说800×600的都有，那么请我们现在如果以各种各样的屏幕来讲的话，我们是不是？
把空间中的点到底投成什么样的坐标就乱掉了，对吧？
我们成了跟屏幕的长宽相关了，这我们啊，可以将xy什么抽象成比例就是ndc了，就是normalized device coordinate。
我们把这个类c啊，统一到负一到一的区间内，我们看什么好处啊？
假设这是一个800×600的屏，那么我们建立这样一个坐标系，这是ndc坐标系，然后呢，我们让这个屏幕的最右边代表，最左边代表负一，最右边代表一，上面一，下面为负一。
然后呢？
假设啊，我们通过一系列的求取，求得了ndc啊，得到是零点三和零点六，这个代表什么？
这个代表啊，它在比如说它现在是正数啊，就代表了它在这个屏幕的这块区域所占的长和高比例啊，这个比例。
那么我们看啊，这个比例也是在每一种屏幕上都是通用的，对吧？
然后呢？
我把它特化成某个屏幕，怎么特化呀？
比如说特化到这个屏幕上，它的像素坐标是什么？
不就是400，加上零点三×400。
对吧，400这块加上零点三乘以这个乘400，因为这个零点三是它的x坐标在这半边的比例OK y上面也是一样的啊，300这一半这一半加上零点六乘三百零点六啊，这块比例乘以300。
直接就算出来了，所以这样的话啊，就方便我们后面做很多的投影呃，做很多的这个光沙发的后期。
那接下来我们再看一看啊，这个投影的分类，第一种投影称为透视投影，什么是透视投影呢？
以人的眼睛或者说我们开了这个摄像机的原点为中心点，然后呢，以某一个角度为张开角来发散出去一个视锥体。
啊，这是一个锥体，然后将所有的物体啊，比如说这个物体，它呢，想想呃，投射到这个屏幕上，那么就用它跟我们的眼睛连一条直线。
连到我们的眼睛上穿过这个屏幕的那个点，就是它这个点在屏幕上点红，然后就被点亮了，那透视投影的话有个好处，就是有近大远小的效果，我们看这个黄球离我们近，红球离我们远，所以黄球大，红球小。
平面来讲的话呢，这个叫做近平面，这个叫做远平面啊，那么只有在这两个平面所形成的锥体范围之内的物体啊，才能够被显示在平外的物体，比如说这个锥体之外的物体，比如说这个绿色的啊，就显示不了了，就被剪裁。
然后呢？
我们看一下正交投影，正交投影，我们可以想象将camera放到无限远的地方，然后呢？
这几条线是不是慢慢的就被拉平了，对吧？
你放的越远，那么它的近大远小的效果就会越小，到最后呢，完全拉平就没有了，所以正交投影啊，是一个投影的是实体盒子呃，可视盒子。
那么，在这个盒子范围之内的物体会被投影过来，盒子范围之外的物体呢？
这个绿的就投影不过来了，也被剪裁了OK，我们先看一看正交投影的推导，这个非常难啊，假设呢，这个坐标系是一个摄像机坐标系。
然后呢？
这个小我们的可视范围等焦投影的可视范围，那么它有几个参数？
首先，近平面n远平面f上平面t下平面b左边的l右面的r。
对不对？
这几个都是数字，那么我们第一步啊，是把这个盒子的中心点啊，拉回原点啊，原点，然后呢，我们可以得到一个平移矩阵。
因为这个平矩阵啊，同样作用在那些点上，是不是那些点也跟着这个盒子做了移动，原来在这的点一移动就移动到这了，对吧？
移动完毕之后呢？
我们现在啊，还不能够判断啊，那么接下来啊，我们还是以这个盒子为基础。
然后呢，对它进行拉伸变换太长的边呢，给它通过一定的比例缩放成角负一到负一到一就是二的长度，然后太短的边呢，给它通过放缩也给它做成负一到一也是二的长度。
那么，这样的话得到了这么一个小盒子，对吧？
那么我们用的第二个矩阵呢？
也就是一个呃缩放矩阵啊，或者是说呃拉伸矩阵。
那么，在得到这个之后呢？
同样的矩阵也应用到我们的那些点上面好，那么我们想要在盒子里面，原来就在这个盒子里面的物体是不是跟着它移动到了这个地方，仍然是在格子里面？
然后并且盒子缩放之后啊，它也会跟着缩放，是不是也会仍然在盒子里面，所以说是没有发生变化，那这样的话呢，盒子外面的物体就被剔除，盒子里面的点就被留着，哎，那么刚好盒子里面的点呢，一定是在负一到一对吧？
xyz都是负一到一了。
那么就可以直接得到它的x和y的nd cok，我们看一下这个绝对。
这个矩阵的平移，找到盒子的中心点，它的中心点怎么求啊？
它的x最大的x加上最小的x÷2最高的y加上最小的y÷2最近的na加上最远的z啊除以二。
然后呢，把它们都变成负数，因为我们这几个点呃，除去负号的这三个坐标啊，就是它的中心点，加上负号呢，就是把它中心点，距离这个零点的这位移啊，给它抹平了，对吧？
抹没了，所以它就被拉回来了，这是。
呃，这个平移矩阵，然后呢？
平移完毕之后呢？
我们再把它缩放到负一到一，那请问负一到一的这个范围是长度是多少啊？
是二对吧？
然后呢，原来它的x的长度是多少呢？
是r-l就是右边减左边得到它的长度用二比上这个长度的话呢，就是我们的缩放比例对吧？
缩放比例，我们看一下，如果用它的这个长度是不是直接乘以这个就得到了二对吧？
那这个比例是成立的同样的比例，再是yz都算出来。
然后呢？
那些比例呢啊？
乘进去啊，乘进去它就被缩放成了这样一个呃，都是二的这么一个立方体啊，那么同样把这个矩阵啊，把这两个矩阵相乘的结果。
叫做正交所用矩阵，把这个矩阵呢用在某一个点的坐标上，它就被缩放到了负一到一的范围，那有些点呢，原来就在外面，那么经过跟着它的平移，还有跟着它的缩放，它肯定也是超出一到一的范围，它的要么是xy啊x，要么是y，要么是z，反正得有一个点。
啊，对一个坐标超出了负110了，所以说呢，就被剪裁掉了OK正交投影非常简单，我们看一看比较复杂的透视投影，透视投影的话呢，大概是这么个样子啊，这什么意思呢？
首先这个坐标是啊，摄像机坐标系的坐标，我们知道我们的眼睛就在这儿啊。
摄像机就在这嘛，原点，然后看向右的副方向，然后呢，我们来规定一下这个平面小的，这个叫近平面远的，这个叫远平面啊，这个叫我们的眼睛的原点，那么我们发散出去之后啊，假设规定的角度这样发散。
啊，我们就得到了这么一个试准。
然后呢？
我们标几个亮出来啊呃，对于我们的近平面来讲，它的r就是它的最右面的x坐标l是最左边的x坐标t，最上面的y坐标b，最下面的y坐标包括啊。
它的英文大家要清楚啊right left是吧？
top bottom n就是near这个n，为什么是复数呢啊？
是因为n啊本身是个正数啊n本身就是个正数，那么为什么是个正数？
它代表的是这个近平面距离我们这个眼睛的距离。
还有一个是f啊，是far远平面，距离我们眼睛的距离距离肯定是正数，所以说在这里啊，我们加了一个负号，表示它的坐标，因为我们看上的是z轴负方向，所以说这个平面是长在z轴的负方向上的啊，它距离我们n它的坐标就是负n喽。
OK，接下来啊，我重新审视一下，其次坐标啊，我们以前学的，其次坐标呢是它的欧米伽样式，一表示个点，要么就是个零表示的是一个什么向量，对吧？
那在这里，我们重提这些问题啊，是因为后面我们有一个概念上的转换啊，需要用这个东西，所以说呢，我们就提出一个问题啊，在奇次坐标下，如果欧米伽不为一或者是零，它用来表示什么东西？
我们给出一个定义啊，当其次坐标下，我们应该不为一或者零的话，那么如下坐标表示的是同一个点什么坐标啊，左边这个我们应该不为零或者是一啊，那么。
我们怎么定义它？
我们直接啊，把它除过来啊，用每一个坐标除以欧米伽，哎，这不就变成一了吗？
所以说呀，这两个表示的同一个点，这表示的也是一个点，只不过啊，它的欧米伽没有变成一而已。
呃，那这个是不是一个什么数学上的概念，或者怎么着，大家不要去这么想，大家就把它理解为啊，我们在图形学当中的这么一个定义，记住OK？
大家记住这个样子之后呢，这个定义之后呢，我们就要开始推导了啊。
首先啊，看一看，我们看一看左边这张图啊，假设啊，我们的演示从这个摄像机坐标系就是这个坐标系呃y轴的正方看一下y轴的负方向啊，这么从上面看下去。
那么我们就会得到这么一个啊，这么一个样子啊，这个试锥体就被摊成一个梯形了，然后呢，我们有一个点在试锥体内x1y1z1。
那么，它要投影到这个近平面上，怎么投影啊？
那是不是与我们的眼睛连个线？
这个焦点就是在这儿好，那么我们就可以构成一个相似三角形，对吧？
从这个点上做垂线，到这个垂点，那垂点到我们眼睛的距离是多少啊？
是负ze对吧？
所以说呢，我们先拿它的这个直角边。
做一个比例是负n比上z1。
负n是不是它n是正数对吧？
所以负n是一个负数ze呢？
由于它是在z轴的负方向，所以说ze是一个负值，那么得出来的比例是一个正数啊，其实就是这个长边比上这个等边。
然后呢，我们再找一边是呃呃，我们再找一个啊，其实就是个短边，也就是个长边啊，我们再找一个短边，这个是什么x坐标对吧？
那么这个短边就是XP，我们把XP啊定义为。
啊再p坐标再p下标的量啊，都定义为点投影到这个屏幕上的这个点的坐标啊，就是project x ok那么这个点到这儿。
是不是x坐标啊？
这个点到这儿是不是也是x坐标啊？
它俩一比例唉，相似三角形就出来了啊，而且它俩都是什么负值？
所以呢，XP就是我们投影上去的这个坐标等于啊，八八八这一堆，我们调整一下啊，把这个符号呢放到把这个符号放到这个a上，好y的方向同样如此，大家自己可以看一看对了。
所以yp等于这个样子啊n×ye比负ze好，我们把这个公式先扔在这不管了啊，看看下面。
下面的话呢，就是我们想啊，把我们投影出来那个VIP啊。
是这个东西啊yp啊，把它变成ndc坐标，我们知道哈，我们看一看，先看左边这张图哈，这怎么做的横轴代表的是yp那么yp的，请问啊，它的可视范围是多少啊？
是不是blt对吧？
为什么呢？
我们看啊。
这对于y方向的可视范围，它最高点就只能是捅到这个这个平面的最高点，对吧？
那这个平面的最高点不就是t吗？
那这个平面的最低点是什么？
坐标值是多少？
是b？
啊，所以说投影完毕之后的那个VIP啊。
它是有范围的啊，它是b到t，那么由于我们ndc是什么来的？
是不是一个比例啊？
对不对？
所以说纵坐标的这个轴代表的就是y的ndc范围，那么最下面的这个b点。
呃，当它yp为b的时候，是不是它的呃ndc小的y就一定是负一，然后呢？
当yp啊投影的那个y坐标往最高点的时候就t的时候，那这个yn DC呢就一定是正一。
对吧OK，因为它是一个按比例进行线性变化的，所以说它俩之间的快转化关系啊，是一条直线，那我们就可以写一个直线方程喽，对吧？
写个直线方程啊yn为了求这个yn。
等于ky t加上一个，我们加上一个北大啊，然后它的斜率少啊啊，斜率不就这么求吗？
对不对？
两个顶点之间啊，斜率的求啊，它的y值啊，最大的y值正一减去负一对吧？
比上一个x方向的这样一个分量x方向的这个差值。
就是t-b是吧？
就是k，然后再一个是前方程，然后呢？
我们再随便挑一个点啊，比如说我们把这个ts 1等ty 1等一带入到方程里面，就能求出求取这个欧米伽啊，求取这个贝塔。
那北塔求开之后呢，我们就可以写出来yn跟yp的关系就是这样的啊yn就是ndc下的YY p呢，就是投影到这个屏幕上的那个值OK？
求取完这个公式之后啊，我们把它推而广之啊y xn呢，也是这样一个关系啊xn的话呢，大家可以自己推导一下，那么你看形式上都差不多是吧，然后yn是刚才我们推导的那个关系啊，现在我们才把这个XP。
x这等于什么？
等于这个是吧？
y这个是吧？
等于这个是吧？
带进去带进去之后啊，大家可以自己手推一下啊，一顿整理啊，两边一顿整就整理出来了，这么一个东西。
我们可以观察一下这个x来讲啊SN是什么ndc下的x坐标，就是我们要求的那个东西，它等于什么呢？
它等于啊，原来在三维坐标系之内的那个点的x坐标用来乘这个加上呢，这个点的y坐标乘。
乘以这么一个第二代，一直会除以这个负5z一这么回事。
这边有这么个解释法对吧？
所以我们就间接得出来了nn DC坐标的x和y值啊，与我们原来那个点的关系啊，但是呢，内值还不知道对吧，内值不知道那么在这里呢，我们看一看啊。
我们将啊，这一坨定义成为xc呃，有人问老师xc是什么啊，我说xc啊是一个中间态，我们把它理解成一个中间态就好了啊，把这坨定义为xc，那是不是xc比上个负ce就等于了SN？
然后呢？
这个yz比上个负一就等于了yn怎么这么去定义它来得到这么一个东西，对吧？
那么接下来呢？
我们要看了，不妨大胆假设一下，对于这两者nd坐标和这个中间态啊c像呃c点。
啊c值或者说啊，它们的z也满足这样一个条件啊，我们假设出来这样的假设假设呢x ndc xyz啊ndc的三个坐标等于。
这个cxc yc zc，我们把c乘以个负的一分之一啊，我们这是假设的啊，看这假设它能不能给我们推出东西来啊？
如果我们令c的坐标欧米伽值为负ze，不就可以代表nbc做了吗？
所以说呢，通过这样的转换，我们看出来啊，这一个我们的中间态的坐标值，这个omega c啊，一定是什么呀？
负ze对吧？
因为这个是负ze乘以这玩意儿才能得出来一个一嘛。
所以我们先知道了我米伽c的值了，肯定是四个一。
哎，那么好了，是不是这个东西它一定与它是代表同一个点？
大家记得刚才我们看到呃，这个其次坐标的时候说了啊，如果一个这样一套一组坐标点一组，其次坐标啊，它有欧米伽c。
然后呢？
这个欧米伽c啊，也不为一不为零，那么它除以一个欧米伽c啊，都都相除，那么得到的这个点的坐标呢？
呃，它俩是等价的。
对吧，所以说呢，我们看这边几个道理。
好，那么现在还是在假设对吧？
对，也满足这个关系啊，我们再看一看，这样的话，我们是不是就能写出这么一个矩阵来了，对吧？
我们的目标变成了什么呢？
我们当时是要求ndc没错吧？
但是我们把它转化成为一个求c啊，我们暂且称为这一组为c向量吧啊，或者说c点啊c点，那么我们转化成为一个求c点坐标的这么一套问题。
那希望我们能给出一个矩阵来，那么我们首先能给出最后一行一定是零零负一零，为什么呢？
因为只有它等于零零负一零的时候啊，那么最好能跟它相乘。
得到的这个欧米伽c啊，才是负ze好，那么我们已经做到这一行了，我们接下来看一看，由于xc刚才咱们定义xc不等于内坨吗？
对吧？
我们把内坨抽出来，等于这个yc，等于这个，所以说我们可以写出这个矩阵的前两行了，对吧？
这一行与它相乘，哎，不就是这个，也就等于l这一行与它相乘，不就是y对吧？
那么现在问题又得到了转化，我们只需要求最后的这一行就好了。
怎么求我们先看一下这个图啊？
对于镜面上来讲啊，你想啊，近平面上来讲，那么不管你x和y如何变化，最后乘以这个矩阵，是不是都等于y啊？
负n对吧？
都等于负n，所以说这个ze啊ze啊，乘以这个矩阵啊，所以说所以说这一行啊，乘以这个向量得到这个zc啊，一定不会随着xe和ye的变化而变化啊，大家一定要说这句话。
求出来的这个最终平面上的这个点的v值啊，一定不会随着它的x和y的变化而变化，对吧？
因为你看怎么动都是这个嘛。
所以说呢，用这一行且这一列所得到的结果一定与xy xy 1般，所以前两是零，那我们就方便了啊，现在变成了这样一个问题，求AB。
怎么求AB呢？
看一下取近平面上的田啊zn=- 1啊，为什么zn=- 1 ndc做表码对吧？
近平面上一定是负一嘛，因为我归一画到这儿。
一一等于多少呢？
那一=-n对吧啊？
就等于负n嘛，这点不是分点嘛？
然后呢？
把它带到这个公司里面去求出来啊，然后呢？
再取远平面上的点zn=1就最远的那个nez 1是一嘛，然后选择那个呢ze是多少是负f对吧？
far平面啊。
然后呢？
我代表代进去，我们就可以得到这样一个方程啊，方程组这样的话呢，就很容易就能把a和b给出来了，我们补全一下这个矩阵，就长这副样子。
啊好，我学完这个矩阵之后，我们再探讨一下考虑对称因素啊，我们知道r和l1定是对称的啊，因为因为我们现在已经转化到了呃，剩下的坐标系了，那么屏幕的左边和右边一定是相对中心点对称的嘛啊，你不可能说做一个十锥体，这个左边和右边不一样是吧？
啊，我们一定要产生这种对称的感觉啊，所以r+l一定是0r正数l1定是个负数嘛r-l呢就等于2r对吧？
等于2r，然后t+b上面和下面相加一个是零，这两个坐标一个是零啊，所以t-b呢一个是2t对吧？
所以说呢，把这个关系带进去，我们就把矩阵给优化成这副样子了啊，优化成这副样子OK？
那么请问我们考虑的上这个坐标系的坐标与投影矩阵相乘之后得到的其实并不是nbc，刚才我们知道求取的是c。
c小c点的坐标啊c坐标。
c都跟ndc之间有什么关系呢？
是不是c都比较粗的欧米伽c是负c1啊？
对不对？
所以说呢，直接让这三个啊，如果我们要得到nc的话，直接把这三个分量除以欧米伽c就完事了，得出来ndc了啊，得出来xi c都是负一到一的比例了。
OK，那么关于投影矩阵给大家讲到这里，希望大家也能多看几遍啊，也要多推导一下来理解这个问题。

