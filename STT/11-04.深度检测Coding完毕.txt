11-04.Vulkan-深度检测Coding完毕

这个地方呢，我们还需要加一句话啊，让它去转一下格式，那怎么转格式呢啊？
那么我们就需要调用set image layout这个函数对吧？
我们来复习一下这个玩意儿，它到底有什么东西啊？
首先我们的new layout啊，要给到它。
然后我们还需要知道说啊，这个source stage mask就是说你的上一个stage是什么？
你的目标stage是什么？
然后呢？
你想怎么做是吧？
sub resource range啊，这个range要怎么搞？
那么还要呃，知道啊，给到一个command pro是吧？
OK。
那么，我们来制作一下啊。
首先这里面有个参数，我们是没有的，就是sub resource range是吧，因为这个东西啊，它是三张depths，里面是公用的，所以放在循环外边啊，在这里我们搞出来一个sub resource range啊。
怎么做呢？
好vk啊image sub resource range哎，这么个东西OK sub resource叫做这个这个region吧？
OK，然后我们把它给置空，然后呢？
这个suprise range啊，它的我们一步步来，首先是aspect mask是吧？
它等于vk image aspect，那么应该是一个深度的beat。
继续呃，它的base mip level我们应该是零，然后它的level count我们只有一个mip map，然后呢？
它的。
呃，这个贝斯。
every layer那么肯定也是零喽，对吧？
然后它的啊叫做layer count，那么应该等于我们只有一个layer是吧？
一张图嘛一。
OK呃，那么接下来我们就要去填充到这里面去啊，把这个函数执行起来，第一个，然后我的目标是什么来的，大家看一下目标啊呃诶转到定义。
那么，我们看这个目标一定是这个，对吧？
d essential attachment optimal这么一种方式，那我们回来把它填写进去。
弄一下格式。
呃，第二个我们是source stage mask啊，就是它的原端啊，我们想一想原端是什么呢？
呃，那应该是说啊，你要刚从这个整个你要从它的头上就开始给我干这件事是吧？
城市头上是vk呃pipeline stage top of park b啊，这是它的源头，那么有些同学到这里啊，经常会搞不清楚什么叫搞不清楚，说我到底是从什么stage开始到什么stage结束是吧，我的目标stage和这个源头stage我总是。
设立不清楚啊，那么我们就看啊呃，你可能是稍微混淆了管线，跟实际的绘制这件事儿啊，我们的管线的stage从上往下流，对吧？
它每一个stage阶段都会流过啊，包括其中虚拟的阶段就transfer的阶段。
对吧，包括computer的这个阶段，那这两个所谓呃，就是在不属于graph这个摆线阶段有留过OK那么呃，由于我们这次指令并没有调并并没有调用什么呢，并没有调用这个呃begin的pass对吧，我们知道come on有一个begin的pass。
那么，我们其实它会流过啊，这些什么to ph line啊，包括说什么啥都会流过，但是它并没有什么的东西啊，是这个意思OK，那么我们就从这儿啊去让它流入对吧？
那么我们的目标的配置是什么呢？
目标配置有个这么个东西啊，叫做type line stage。
叫early fragment test唉，我们之前讲过，说有一个early z对不对？
就是说你的深度点发生在fragment什么之前和光山化之后，那么指的就是这个阶段啊，那么我这个阶段。
我就要等待你转换完毕，这么个意思好，那么接下来我们再看一下它需要什么，它需要一个saber source range，对吧？
我们这边这块有一个reading给到它。
接下来就是come on poor哎，come on poor怎么办呢？
我们看一下OK？
嗯，这没有come out for没有come out for的话呢，我们也没办法啊，我们只能够在所有这样放电的时候给它传一个参数进来。
那么，这样做还是有一点点的，怎么着有一点丑对吧？
但是呢啊，这样的做法在教学里面是可以的，我们在这个引擎层啊，在写的时候会切得更碎，切得更细啊，把一些资源独立出来，你比如说它属于资源啊，在这里再给大家强调一下这一点啊。
然后好，我们继续学习啊，我们这个这这这次的课程都本着学习的这样一个态度，而不是说去知道代码写完了，我们就可以写一套什么什么引擎，对吧？
这个引擎的课程呢，我们会在后面推出来啊好。
在这里const command poor。
点，然后come on up for我们传一个临时对象就好了啊，左边要一个。
OK，把这个啊再拿给s open创建的时候，这边我们也调整一下参数啊，为了让大家看得更清楚呢，字体比较大啊，所以这边就用这种方式调节一下，当然这种参数比较多的时候，这种堆积方式啊，是比较好的一种感觉啊。
然后大家也可以学习一下这种写法，好，接下来我们有了什么啊？
command pool拿到了OK，这样的话就没有问题了啊，那么格式转换完毕啊，我们再去去这个command pool生成的时候啊，里面我们看一看，这边应该就错了，对吧？
因为缺一个参数嘛呃create。
这边啊，我们要把这个command pool它的生成，还要再稍微呃提前一下吗？
我看一看啊。
应该是在啊，这边儿。
在这边啊innate locker的时候呃，我们找找command pro诶，这在它后面是吧？
呃，不行，我们要把它再往前放一放吧，放到它前面去。
啊，没问题，然后呢？
把它拿进来。
然后呢，在下面re pre ate sorption的时候啊，就是sorption的重建这边呢，我们也需要给它一个参数command pro好呃，然后我们清理。
这边这个缓存。
好生成一下。
它是有错误，还有哪个是没有没有没有接纳呀？
OK，那应该在这里啊stop chain这里面的话呢？
create啊，这边还没有给到它。
好，再来一下。
OK啊诶，这边是有问题了，它说什么呢啊？
它说这个vkf buffer quit infer啊at这个东西do not match attachment count of这个。
就是就是说我们现在运行的话，会有一个的错误，大家可能看不清啊，跟大家说一下呃，那个地方的话呢，就是呃，它还没有把它设置到人家pass里面。
但是我们的frame b的创建是依赖于人的pass的。
这个错别很有意思啊，大家看呃在create frame buffer里边，我找找啊create frame buffer这个地方啊，这个地方呢，就是在里面，我们要做frame buffer，那么在这个地方诶，有一个校验就是要。
针对renda pass的校验，我们的renda pass还没有把深度的这个这个attachment加上去啊，所以说你看be tassi a layer碧海啊，它马上就给你检测出来，说你这个renda pass里面只有color attachments，也没看到你用defs attachments，对不对啊？
你的free buffer里面怎么就就搞进来了一个呢啊？
它是这个意思。
okay，好，那么我们看一下时间。
嗯，可以，那么这节课接下来我们就要处理这个问题了呃，就是文档pass里面呢，我要加进去这个frame呃，加进去这个depth buffer。
好，那么我们回到application看一看啊，在创建云端pass的时候，我们到底干什么？
首先，输入画布描述大家复习一下，然后我做了一个索引是吧？
reference创建子流程创建依赖，然后最终搞进去啊搞进去。
我们一步一步来更改，首先这边啊，做了一个描述，那么我们是不是也要对这个depth buffer啊进行个描述呢？
叫depth attachment，所以说我们还要再做一个attachment vk attachment来，我们抄一下吧。
哦。
在这打一下深度缓存attachment。
啊，然后呢？
把它的这些参数还有这个啊，这些参数我们抄一下。
然后一个一个的看啊，不能漏啊，搞错一个呢，要被外地师那样给批评了是吧？
就不开心了。
首先，它的from net。
它的format应该等于什么呢？
是不是应该等于image，然后呃image诶？
这个image我是不是引进来嘛？
好，我们把image弄进来啊，include image嗯，include应该叫welcome wrapper下面的那个image点h，我们之前不是写了一个静态函数嘛，对吧？
它可以获取到啊，一个我们当前的depth offer的这样一个。
呃，格式。
应该都有这吧。
image on.看一下它到什么来，能看出什么？
啊，我们把它private到了啊，private到了呃，所以这两个啊，我们把它拿出来吧。
好对了，还是拿出来find support for matt啊，find support matt的话呢，我们需要传入这么多东西啊，那么在这一步上的话，我们。
我们看这个函数啊，它有很多的参数，对吧？
那么这个其实也不太怎么不太适合我们直接在那边调用啊？
太麻烦了，我们在它的函数上面包一层啊static。
喂，可以放麦。
叫做find depth format。
okay，这函数呢？
我们就不给它传参数了啊，我们直接去实现一下。
点image。
OK，那这个函数里面写什么内容呢？
呃，写的内容啊，应该是这样的啊，我们先回到哪里呢？
我们先回到上面啊，看是不是在上面啊，好像不是在上面啊，代码太多了啊，我们回到里面是点h这边呢，有一个。
我们之前写的静态方法诶，都是它对吧？
create depth image。
这里边的话呢，就有这几个步骤啊，那么find诶，这两个步骤我们可以拿过来用，对吧？
像我们刚写的find depth format，从里面拷进来啊，那么这边是含有一个device啊，我们把这个device呢，也给它搞进来。
ami CEO kay，过来。
加进去啊，等于有了，那么我们接下来就return诶return这个result format就可以了是吧？
呃，其实就是result这个的结果。
return这个结果。
好，然后啊，经过了这么弯弯绕，我们再回到。
这个vacation这一端啊，这边这边的话呢，是不是就可以拿到这个深度格式来find fs format，它需要传入的是一个device。
好这一步，我们做完了，大家看啊，它的东西太碎了，多了啊，那么我们就是在写我们自己的这个程序的时候啊，就是边写边补，边写边补很多函数呢，如果说一口气给大家写出来诶，可能你就会迷惑函数是干嘛的，为什么这样对吧？
OK，那么慢慢的呢，其实就能形成一个我们自己的引擎啊OK，我们继续来看这个东西啊。
嗯，它的load operation，那像这边采样的话，还是一码，我们还没有抗锯齿啊，还没有在做那么load operation，这边clear是吧？
你加载进来的时候先把你给clear掉，那么你这边做完之后呢？
还用着去像素保存吗？
其实不用保存对吧？
不用保存，因为我们也不需要从APP上反向读回来。
什么东西，或者利用它做什么东西OK那么诶，有同学就问了说啊，为什么这个color这边是需要做story呢？
因为它需要把它保存下来，然后需要给谁啊，然后我们的屏幕的这个显示引擎去读取它，对吧？
所以说呢，你不能把它告白。
但是这边儿呢是在哎，我们这个rent pass走完了，它就没了，因为我们走完了就已经把这个fragment输出到图片上了，其实就不需要它的深度析了，我已经用完你了啊OK，那么这边儿的话呢就是vk。
呃，叫做attachment shipment。
store嗯operation don't care啊，我不管你好，我们再看一下30这边我们也给它don't care就好了啊，我们没用到它initial还是按defined finally out是什么呢？
这个layout就应该是什么了呀？
应该是啊v image layout depths stan ti al啊optimal啊，我们最终的这个格式一定是这样的啊，最终格式一定是这样的，那么接下来我们要看一下对于它的索引，我们应该怎么写哦，大家注意这个地方啊。
看这个地方，一个不小心都忘了，所以拷贝代码灯不是一个好的事情啊啊，要仔细。
那么，接下来我们做它的索引，我先拷贝一下啊，这个attachment reference呢，叫做depth attachment reference。
okay，先拷过来。
它的后面才我们把它摆到一号，对吧？
在这样一个啊，一会儿我们要组装的数组里面啊，那么它就应该是被放到了二号一二号位啊，对应的数组里面就是零一对吧？
就是一号位这样子。
然后呢？
这边呃，应该有一个我们的LED，那么这个LED就是它啊，在进入我们当前surpass的时候，由于这个surpass呢，引用了这个reference，对吧？
它所代表的这个图像。
那么，我们就需要提出要求，说你进我这个pass之前啊，你要给我搞成这个啊，好那么这边的话呢，我们还有一步，就是要把它加到这个radar pass里面啊，把它加到radar pass里面，我们看一看radar pass这个是怎么定义来的啊？
这边有一个add dependence，add attachment呃，我们add attachment的时候呢，会把它加入到这样一个touch ment的数组里面，它就形成一定的什么一定的顺序，你先加的呢，它就放在前面，后加的它会放在后面啊。
我们来复习一下，这边就有一个achievement descriptions的数组对吧？
好，那么这样的话，我们再回到这边呃，我们把它加进去。
好，那这样depth我们也加进去了，那么接下来继续看创建子流程就是saber pass的时候，它到底做了什么？
我这边有一个add color attachment reference对吧？
在这里面的话呢啊saber pass里面呢？
关于深度的设置，应该是一个独立的set step essential attachment methods，这是咱们之前写的一个函数啊，因为这边的话呢啊，我们看是一个独立的存储结构诶，所以这个以前我们的设计也给我们造成了很多方便的地方啊。
把它导进去，叫set depths，然后呢？
depths attachment reference唉，给它设置进去，那么这边是build sub pass的description对吧？
build把它给这样一个build起来，我们看这边也已经设置了是吧？
啊，那么这边说呢，如果它的layout不等于这个undefined，那就是null，否则就是我们当前传进来的这个值的一个保存值在这类。
所以这个这句话大家就可以重新审视一下了啊呃，因为我们在外面设置的它的reference layout是什么呀？
是depths optimal对吧？
所以到这呢，肯定就不走这句了啊，不走这个now了，它走的就是。
这边啊，所以就能设置进去了OK，看来之前的设计还是没有问题啊，比较好，然后呢，把它给搞进来，搞进来之后呢，这边不需要更改，这边不需要更改啊OK？
那么，关于这个renda pas的设置啊，应该也就没有什么问题了啊，renda pas的设置没有什么问题了。
那我们再看一看这个地方吧，看看这个地方还有点担心啊，这里没有写嗯，在这边的话呢dependency啊OK？
我们看一下诶，这个create infer的时候，我们好像还有一个东西没有做啊，看是不是呢？
okay，dependency，dependency啊，也没有问题啊。
好，那么我们接下来跑跑看，首先还是生成缓存，然后呢，全部清理好起来。
诶，在这个地方出现了问题啊，我们看下面列列列说什么呢？
这边大家可能还看不清啊，这个我给大家说一下，它说呀呃depth stench of state is now when restoration is enabled and sub pass use the depths。
等于说attachment就是说呀，你在这个create唉，怎么样？
它create pipeline的时候，它说你那个sub pass里面你引用了一个深度缓存啊，但是你在我这里，你你根本就你这个state就根本就没给我做呀呃，你是这个套啊。
怎么去理解这个states now？
我们看一下pipeline create infer啊，pipeline create infer里面，它会有一个step state，我们这个地方是个now 1堆的零，我们没有给它做啊，好，那么我们接下来的任务啊，就是要把这个steps ta ntia l这个state给它补上。
好，那么我们再回头啊，看看pipeline呃，做到这里稍微呃等几秒钟，大家回忆回来啊，我们前面做了关于run a pass的一堆东西，对吧？
run a pass这边弄完后呢，跟pipeline不匹配了，所以pipeline这边我们需要去做。
depth stencil state这么一个东西的设置啊，是这个意思啊？
OK我们回到呃这里呃dials tan TIA lo k，那么这边我们看看啊呃，我们这边已经设置shader设置视口a ing，然后呢？
这一堆东西里面我们需要把。
step state诶，这里一个to do是吧诶，这边的to do已经结束了，需要这边的to do呢，就得要放上了。
啊，等于depth。
sensor state这个我们之前写了啊，给大家回顾一下。
是不是它是这个东西啊？
它这么个东西，这个东西呢？
它就来规定我的深度检测等等怎么去做的问题是这样OK？
那么我们呃去到这个。
按分开视频啊，去给它先做一下设置，我们看看这个设置能不能从这做？
在这边呢，我们呃给它做了一堆的设置，但是我们这边还没有做是吧？
所以在这边呢，我们给它做上吧，那这节课的时间比较长，大家呢，也可以去分段观看啊apps。
那这边我们需要看一下有哪些需要设置的东西啊，这里边的话呢，首先要有一个呃depth test enable我们给它vk true，就允许你去做啊，然后呢，我们再来一个m。
呃，他扣过来吧。
首先，打开深度测试是吧？
打开深度测试后呢？
我们还要打开一个什么呀？
呃，叫做depth right interval，就是说允许所有的物体往这个深度缓存里面去写入数据。
否则的话，你就这个深度虽然开着，但是但是它里面永远都是一嘛，对吧？
没有人去写啊，那这个地方大家注意一下啊呃，然后是depths compare operation，我们用Vicky compare。
用less equal啊，就是小于等于才往里写入啊，大家记住小于等于才往里写入。
OK，接下来我们看一看还有什么要做的啊？
depths BS test name这些东西我们都给它，已经吃空了这些事情的话都都不重要啊嗯。
因为我们并没有开启啊，这个东西是干嘛的呢？
就是说呀，我的depth是零到一嘛，对吧？
然后呢？
我想说啊，这个零到零点五行不行？
零点五后面的都给它干掉，可不可以啊？
可以呀，你就把它开启。
开启之后呢，你把min APP设置为零，把max给设置成为零点五，唉，零点五后面的就可以都给你剪掉了，那么我零点一到零点二行不行啊？
可以啊，把m in做成零点一，把它做成零点二，并且开启它就可以了。
OK，那我们现在不开启啊，不开启好，这样的话呢，你看我们在这设置了，然后在pipeline的build里面呢，我们又给它做进去了，所以说现在呢，应该是可以了是吧，我们看一看。
诶，又出现了错误啊呃，说什么呢？
cmd begin render pass他说呢？
呃，这个大家也看不清，再给大家念一下这些错误都非常有意思，我觉得你们在自己编程的时候也会遇到它啊。
在cmd begin rn AR pass的时候，就是我们come on的要开始。
rn AR pass的时候，它说clear color count只有一个，它必须是两个才可以OK，那就是我们之前PPT说的啊。
我们来找一找这个begin red adar pass在哪来着？
这边我们看一下嗯，叫做create command诶，create command ls对吧？
在这里我们只设置了一个clear color啊，就设一个clear color，那这肯定是不够的呀。
对吧，肯定是不够的，所以说呢，在这边我要做两个特定color了，因为我们有两个attachment，一个是颜色，一个是深度，对吧？
搞进去clear colors诶这样子，然后我做的第一个clear color呢，我就不改名字了啊push。
back它连上color。
OK，我们再做第二个，可别color叫depth，可别color。
对depth。
clear color那么我们我们来观察一下clear color这样一个结构体啊，我们看它是这样子排布的啊，这样子排布的对吧，那么我们就可以直接把它做出来设置，也可以把它做设置。
我们以前的设置方法是直接这样的啊，这样的设置方法呢，其实可以，因为它是填充前面的字形嘛，但是现在呢，我们啊，让它稍微的仔细一点吧。
呃，先把它声明出来，然后我们让这个颜色呢，也给它改一改它的color，等于这么个东西，那这边的话呢，我们也是啊，把它去掉，然后先吃空，然后呢，把它。
的depths sten SIL拿出来，然后等于给depths核s den SIL各自赋值。
depths是最大的，值一点零啊，每次都得刷成一点零，而stensil呢，给它刷成零就好了，因为stensil我们也没有用到，对吧？
然后把它复制进去。
好，这边的话呢，是把它用起来der ta te past呃，做成了int 32更替。
好，这边是clear colors。
size这边的话就是clear colors的内容。
给它OK，这样的话质量差了也有了呃，不知道这个我们的程序呃m还有谁运营呢？
它会不会还乱我们闹呢？
呵呵，不知道啊，看一看。
诶，没有问题了，大家看是这样的一个奇怪的画面，为什么呢？
因为我做了一些调整啊，是这样的啊，我在model里面啊，这里啊，我提前给大家准备一些数据哦，准备一些数据，这几个是一个模型，是一个正方形，我把第二个正方形啊，稍微扯了就是。
扯的形状很奇怪一样，你看就是把这边呃一点八，这边是负零点八，就把它的x方向折比较厉害啊，所以会形成一个很奇怪的菱形，然后呢，它的深度是零点二啊，它深度是零点二，它的z值是零点二，所以说它应该在上面这个正常的正方形的。
下面啊，那么这些数据呢，我们就不带大家看了，这个大家自己回去拿代码去看就好了，非常简单啊，所以说我们运行出来呢。
啊，就会是这个样子啊，就会这个样子，大家看啊，比较奇怪的，这个形状是在这个正常的形状的下面啊，那么这样就是对的了OK啊，那个漫长的课程是吧，这节课比较时间比较长呃，各位同学也要仔细看啊，建议多看几遍，把这些系统啊都搞清楚一点OK散会。

