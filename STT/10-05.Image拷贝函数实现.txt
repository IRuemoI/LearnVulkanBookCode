10-05.Vulkan-Image拷贝函数实现

啊，我们这节课继续去进行这个格式的转换，然后我们在做格式转换之前啊，我们先做一件事啊，在这边我们的layout。
需要是不是把它更新成为new layout，对吧？
new layout这个地方很重要啊，千万不要忘记啊，否则的话你就失去了记录点了啊，好那么在这边的话呢，我需要生成一个什么是杠八八块对吧，所以说呢，在这边我需要把杠八块搞进来啊。
一个的哎AK啊，不是commander来点儿h，然后呢，为了构建一个command buffer，我是不是应该还需要一个什么呀？
command poor对吧？
需要一个这个东西好，那么在这个地方有一个设计上的问题啊，各位一我写在这个API的啊上方啊，写在这个API上方。
这里啊，此处属于什么呢？
属于一个便捷的啊，写法封装性啊比较好对吧？
但是。
可以独立作为一个工具函数。
写到tool啊，写到tool A类里面是这个意思啊，那么这个我们为了调学方便啊，我们就不把这个函数单独拆到一个tool里面了啊，其实一般引擎里面是可以把它写到tool里面的啊，那这样的话呢set应该是料它，其实我们是需要一个参数的啊OK，那么我我们把这个tool啊。
呃，把它拿出来嗯，在哪里呢？
这个image里面啊，我们这个这个这两个东西啊，我们把这个东西要拿出来了，拿出来之后给它放哪呢呢？
放到image点h的上方啊，这里是一个思考题啊，一个大家自己的选择啊。
OK，那么这边的话呢？
说这个我们是不是应该把这个tool放把这个command tool放上去啊？
p2这里我们加个心电图。
呃，poor。
okay，把它拿过来。
呃，image。
嗯，match。
OK，好的，拿到image，拿到command pro，那接下来呢？
我们就开过command auto command。
buffer等于啊，command buffer。
create好，create传入，首先传入一个device是吧？
传入device，那么我们看一下这个有没有存device啊？
啊，它所有device可以啊，好习惯。
m device其次需要传了传了一个command pool对吧？
好，我们把这个command pool给进去好，这个指令就完成了是吧？
完成指令之后呢？
我们啊是需要做一系列的东西的对吧？
关于这个指令的一些开始啊，结束啊等等是吧？
好，那在这里我们仔细想一想啊呃，我们当前的这次指令执行会放在什么阶段做呢？
那是不是说我们做了一个image出来，然后我们呢？
把数据拷贝到一个CD版本是吧？
然后我们开始做这个格式转换啊。
那这个都是一次性的，都会放在一个游戏的初始化的时候去做，对吧？
初始化的时候生成这个开始，或者是说啊，在进行某次渲染或者场景转化的时候，我要换一批资源了，那么这个是一次性的执行，对不对？
所以这个可能的法法它并不会啊，在这次指令执行完毕之后还继续存留，它不会继续存留的。
啊，所以说呢，我们的command buffer啊，它一定是一次性的，我们看一下啊，command buffer这边首先有一个begin begin里面呢，其实是有两个参数的，一个是如果你是二级指令，那么它有一个继承消息啊，如果哎，大家看第一个flags是吧，它如果说是。
一次性执行就完毕了啊，不会做，不会使用它，第二次的话，我们看一看啊，那么诶，是不是有这么一个参数啊？
对吧诶usage one time sub let呃，我所以说呢，我们在这边把这个参数填进来诶，它就可以被执行一次是吧，然后come on buffer，我们就给它来个end。
好，那么在这个中间，我们要干什么呢？
是不是command buffer？
我们要去做呃，这分image layout是吧？
那么它的match barrier是什么呢？
就把当前的这个家伙给它传进去啊，就这个image barrier传进去就好了。
然后接下来呢，是它的source stage mask啊，那么我们这个stage mask写什么呢？
因为你看我们这个指令在执行的时候，其实并没有去begin pass是吧？
所以说我们其实呢，走的就是那个transfer的那个stage啊，所以我们的stage也是我们的stage是什么是transfer？
所谓k pipeline stage transfer。
bit okay，那么我们的dest是什么呢？
也是一个transfer bit方，okay？
那么我们就走完了，这个指令就走完了是吧？
走完之后呢？
我们接下来就要做提交，那我们看一下我们原我们定义的这个command里面啊，有没有相关的函数啊？
提交函数。
哎，这个是不是啊？
submit sync我们看一下啊，以前的submit sync呢？
是说啊，要等待为I的是吧？
等待这个指令执行完毕啊，所以submit的时候呢，还需要一个什么一个q啊，需要一个q。
那这个q是什么q呢？
就是我们这个device里面可以拿出的这个q对吧？
所以说我们用这个submit就可以了，它会等待它执行完毕啊，等待执行完毕OK？
到这submits呃好，我们看一下啊，这个首先是个q啊m device。
呃，叫做add graphics诶，用family就可以了。
然后接下来呢诶，这个device。
我先看一下啊，这边这个fence它没有一个默认值啊，但是在这边呢，我们是不需要，所以要给它一个，我们也可以拿翻到啊，给它一个默认值吧，因为在这边不需要face原因，非常简单，其实这个函数本身也是不需要face啊。
啊，因为这个地方的话，就是为它哀悼啊，它不需要等，不需要说这个分子来通知它是否完成啊，就是直接为它OK，那么我们现在去到这个函数，我们再看还剩问题啊。
这个是需要一个哦，需要一个q，那么是q family了啊。
get map to啊，把这个q打开就可以好，这样的话，那么这个指令就同步完毕了啊，就同步完毕了，好，那么这个就是set image layout的，这么一个写法。
好在这边的话，再给大家提醒一下这个东西呢，其实是可以啊，是可以写到poor里面的啊，其实会更加清晰，但是这边呢就不大费周章了啊，就这边直接给大家这样去写了，因为它需要传递更多的poor进来啊，就非常不美观啊，非常美。
OK，那么我们看一下还缺少什么函数呢？
我们是不是还缺少一个将image data给复制到啊？
复制到我们的这个image里面的这么一个功能，还缺这个东西，所以我们需要一个贸易的。
叫做feel image data。
啊，假设我们已经把一张图片读出来了，我们知道它，知道它的长宽size是吧？
知道它的这个data啊，一个挖掘性的data，那么我们如何把它传输进来啊？
首先是它的size。
size okay，然后接下来呢，就是它的什么呀呃data啊，这个data的话呢，我们啊用什么来表示呢，我们就用一个y类型啊y类型吧。
这么一个p data好，我们先写这两个参数啊。
我们去实现一下。
把帽子拿过来。
那么在这里呢？
我们首先要对这个data判个空，是不是啊？
就是assert吧assert p data啊就可以了。
然后呢？
我们还要看一下啊，一下size。
好啊诶OK，那么接下来我们讲一讲是不是啊？
它如果想要把这个data复制到我们的EMS的打法里的话，我们一定需要一个什么要一个stage buffer，一个中间buffer，对吧？
所以说呢，我们就需要在这里啊，再有一个文件include buffer点h，然后啊，我们要创建一个，那么我们去填写参数呢，都比较复杂，所以我们要怎么做呢？
看我们在这里有三种对不对？
我们再加一种就好了嘛。
当然，这个pdr我们叫great stage buffer诶，这样就舒服多了啊，great stage buffer的话呢，我们是不是也是啊这一堆？
给它搞进来啊，好，那么我们也是去到文件里实现一下。
OK，豹子，豹子。
有呃，好的，那么我们首先auto buffer=buffer grade。
你要处理一个什么样的事呢？
按下参数啊，首先device呃，我们对比下面去写，然后size有啥问题呃，然后它的种类呃，它的种类这边的种类我们应该怎么去定呢呃，这边种类的确定我们看一下上面是一个，比如这个函数啊，它用的是uniform八二b的，说明它是用于被传输uniform的。
我们看一下还有没有其他的品类啊？
嗯，发现了是不是啊？
它有一个source beat这个stage buffer啊，它一定是一个什么呀？
是从一个stage buffer拷贝向一个image的buffer，所以说stage buffer是一个source buffer it。
OK，那么我们过来它是一个这个，然后这个还满足什么条件呢？
还满足条件就是一定是host visible的对吧？
并且是CON here nt的啊，就是说你拷贝之后立马被同步进去啊CON here nt。
好搞过来。
啊，接下来呢，这个create就做完了啊，做完了，做完之后呢，我们就开始啊，把它拷贝数据，先把当中备数据啊，如果p data不等于now pdr，对吧？
那么我们呢，就用buffer叫做update by map，因为我们毕竟是host，visible CON here nt是吧？
所以这个里面的参数是什么呀？
看一下。
一个是这样，还有一个是size。
嗯okay，那么这样一个stage buffer我们就创建好了啊，我们再回到我们的image里面这里啊。
我们看一看file image data在这里auto叫chal pha=alpha。
create一个stage buffer，它的device。
sine西贝塔OK就传进来了是吧？
这样我们c把法就做好，且它上面已经包含了相关的数据啊，包含了相关的数据。
那么，我们接下来的目标是什么呢？
接下来的目标就是啊，将它进行拷贝啊，进行拷贝，那么我们接下来要进行的操作呢？
呃，就是将一个buffer啊，这些个简单的Vicky buffer是吧？
拷贝到一个image上面去啊，它的操作呀，其实跟我们之前实现的buffer拷贝到buffer上是不太一样的啊，那么我们呢，先看一看这个command里面啊。
知道com的buffer诶，它原来是不是有一个copy buffer对吧？
我们把这个函数啊，先改个名字copy copy buffer to buffer啊，这样子才能够非常明显的表示出来，这个是buffer to buffer的一个拷贝啊。
okay，那然后呢？
我们再写另外一个函数。
哇，copy bar bar two image诶，你这样写的话呢，是不是就非常清晰了对吧？
那首先呢，我们肯定要知道哪个image要被拷贝啊，所以vk image。
啊image好那么拷贝它的长宽啊，这些怎么办呢？
就说我们要拷贝的范围是什么啊？
拷贝的范围那么好size t。
宽度size。
七诶高度诶就可以了啊，然后我们去实现一下。
在它旁边吧，这里啊。
OK，我们来看一下啊，那么为了拷贝一个buffer啊，拷贝一个buffer to image呢，我们就只要知道啊，这么一个拷贝的范围啊vk image a buffer。
image copy，我们需要这么一个参数啊，这个参数呢，其实它是一个什么是一个region？
是一个范围啊，帮你拷贝什么样的范围OK？
那么这个red region首先我们buffer offset，我们有没有offset呀啊？
我们是不需要offset对吧？
然后呢？
它的buffer我们设置为零啊，这个为什么是零呢？
一会给大家说啊buffer image hit我们变成零。
好，这两个数据为零啊，这个为零代表不需要进行这个padding padding什么意思啊？
padding是为了内存对齐啊，本来我的数据假设有个有个五个byte吧，你把它对齐成八个byte啊，多加了一些这种。
这个呃空的数据啊，所以我们不需要这个padding啊，文件代表不需要iding好。
接下来，我们对region的其他区域进行一下操作啊，叫做image sub source啊。
谈到sub source的时候，我们就知道啊，它要对image的，除了它的，你看我们上面哈，是它横向的，也就是说这张image给你面前铺平了是吧？
你要复制哪个范围？
哎，但是到了下面的话呢，就开始纵向的了，什么是纵向的呢？
就是说啊，首先我要考虑把它理解成为一个color image呢，还是理解成一个depths image来拷贝呢？
我到底对于mm apm map是什么呀？
其实就是说啊，根据这个缩放的远近大小调整这张图片的分辨率啊，它会有很多mmap的层。
这个我们会不会讲啊？
你看没有map对吧？
这样一个纵向的数据感，然后是它的layer，我们之前说了一个什么呀，是不是一个一个可以match，可以有多张的什么呀？
多张的图片啊，对吧？
叠加在一起成为一个cube呃cube map啊，成为一个天空盒子，六张图片都压在一张图片里面，所以说呢，它有一个layer，这一说对吧？
都要进行设置，我到底是哪个？
好，我先把aspect mask给它放在这儿啊aspect mask mask呢，我们先把它默认写成啊，我们也可以match这个aspect。
我们是它一张这个颜色的图片啊，是一张纹理并不是一个什么depth，对吧？
那么如果有需要的时候呢，我们再对这个接口啊进行扩展，然后它的mip map level当然是零。
然后呢？
什么意思？
零什么意思啊？
就是我们只有一个nip level nip nip level层对吧？
那么这个开头的索引一定是零号啊，第一张图片零号我们就一张图片，然后base every layer，那么当然也是什么是零号对吧？
因为我们只有一个layer。
然后呢，它的layer count我们只有一个点好，然后接下来呢，就是说呃，这个呃region in s offset。
我们并没有offset=0啊，这个的话呢？
零零零啊。
然后接下来还有它的image accident，就是它的旁观，我们设置一下。
宽度，高度，深度OK。
接下来呢，我们需要进行拷贝命令了，为给cmd copy buffer to image哎，你看这个指令也非常清晰，对吧？
我们看一下它需要什么样的参数？
它需要一个command buffer一个。
哎，这个没有加帽子啊。
m command buffer第二个参数是一个buffer，就是source buffer啊，那么source buffer是什么呢诶？
我们这边还没有写source buffer啊。
在这里，我们要写上buffer，所以可以。
vk buffer buffer这个我们稍微的把它修饰一下source buffer和deck image。
对好。
source版本。
然后呢image再等image。
然后是desk image layout啊，那么我们现在的layout是什么呢？
大家想一想，这个layout会是什么？
如果说你要做传输的话啊，那么这个layout现在已是啊，一定是它的，这个一定是它的，这个source对吧？
它是一个呃desk是一个desk transfer desk。
那是为了这个严谨起见呢，我们就需要传入进来啊，需要传入进来那么好，这边的话我们再思考一下，你看我们的接口啊，进行了多次的更改是吧，就是为了在想这个到底该怎么办啊？
呃，在这边的话呢，我们倒不如说啊，我们倒不如说直接传入一个嗯，说什么呢？
我们这样吧。
呃，想一下嗯，我们直接把它拆开传吧OK？
也可以image layout。
叫做desk image layout啊，为什么这么传呢？
其实本来刚才想的是啊，如果叫buffer啊和image直接我们封装好的那个类传就那就好了，但是我后来一想啊，就是这种wrapper的底层啊，我们还是全部拆开会比较好一些，防止它们过度的互相之间有个什么一个循环引用啊，有循环引用。
比较麻烦一点好，那我们这么说吧，传进来一个料子。
我们把校验这件事啊，留到这个外面。
诶，给。
呃零诶，点错了。
好看一下，所以这边是dust，应该是delta。
接下来呢，我们要有一个region count，我们region count是一，然后region就是刚才那个region。
好，那么这边就成立了是吧？
这个指定就录入了啊，那么我们现在回到image啊，回到image。
然后我们要进行这个拷贝啊，大家知道要进行一个拷贝的话，一定要怎么着？
是不是还是要去生成个command是吧？
那么我们就需要在这auto command buffer=command。
buffer那么它的create。
亏的时候又需要device了，device还需要一个什么command pro对吧？
所以说同样这边也需要一个command pro啊，我们再去修改接口。
到这儿来command pool。
皮条左下线定符吧，抗死。
command for好把这段拷拷过来。
这边儿command for。
OK，这样的话，我们command buffer就成型了，然后command buffer首先一定要什么begin是吧？
那begin的时候呢，又产生了一个问题，就是说它仍然是实性的，对吧？
我们用一下就不要了，就做一次好，然后command buffer。
end，okay，接下来我们调用command buffer。
叫做呃copy buffer to image啊，copy buffer to image，然后上面传入首先是一个source buffer，就是stage buffer。
get buffer.然后是image啊，就是我们的m image。
然后它的LA you TM layout当前记录的layout，然后它的宽度和高度mw mvs诶，宽高是不是没有记录啊？
看一下。
OK，我们在这边还要记录上宽高的数据啊呃，首先int吧嗯，thanks t。
m宽度。
37m高度。
初始化一下好，然后再说net啊。
在这边把它给协商。
呃，等于eight OK，这样也记录下来了，我们继续写这个函数啊，这样一个片酬的过程呢，其实是让能让大家看到啊，咱们在写一个小小的wrapper，或者说引擎前期的时候会遇到各式各样的问题啊。
我们一定是要这个走到哪里，我们就去修改到哪里啊，就是很多同学说为什么不事先设计好啊，什么什么的，其实你设计是很难，是一个很细的力度的是吧，所以说这样的话其实也是可以的。
啊，边写边改，否则呢，你会畏惧不敢前行啊，好那么这个命令，我们要录制进去了，录制完毕之后仍然需要一个什么呢？
是不是需要一个submit think提交到哪里呢？
还是提交到它的？
get graphic q里面去啊，好那么file image data我们也做完了，那么应该还有一些bug啊，我们跑一跑看一看啊，还有什么bug，因为我们刚才改了名字啊。
那首先是一个这个啊，首先是这个呃，这个宽高是个问题啊，我们传的宽高是这个，我们现在把它改成u32。
因为刚才那个呢是六是一个呃三十七三十七的话呢，64位的话，它就是四位啊，会被申请这个不太好啊，会出错，我们去到这边儿把这边儿也改了。
好，我们再查查还有什么办法？
呃，OK。
呃，这边啊，放上参数。
okay，还有什么呀？
嗯，copy buffer啊，所有buffer这个我们改名了啊，再试一下还有。
嗯，这边create这八份必须打一个值啊，没有返回给它看成八份。
好，再看一下。
诶啊，目前语法错误就没有了，好OK，那么我们的课呢就写完了，关于set image net的指令执行以及我们做了一个file image data的这么一个函数。
我们这节课就先到这里。

