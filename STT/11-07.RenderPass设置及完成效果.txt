11-07.Vulkan-RenderPass设置及完成效果

各位同学啊大家好上节课呢可以image这个类添加了一个方法这个方法是一个静态方法啊它能够去创建一张用render target多重采样的图片，我们这节课呢有几个任务啊这个任务啊首先第一个任务是在sub chain里面发生的就是说建立创建啊一张multi，sample的图片啊然后呢并且加入到frame buffer里面，我们知道frame buffer它是一个集合它呢是将所有这个render pass里面所用到的面啊就是说输入目标都给它加入到frame buffer这样一个集合里面的这么一个东西，那么我们想要多重采样它的过程再给大家重申一遍颜色会首先被记录到multi三跑这张图片上它呢会作为resolved attachment就是说它是被用于resolve这件事的attachment，然后呢把它解决到resolve到咱们sub chain里面诶自动创建的这张图片上，ok好那么我们就先来做一个这个multi sample的图片诶就是这个这你就写在这儿给大家写一遍吧，我们去创建多重采样的中间图片啊是f td fr，image trm multi sample images,你这张图片呢我们需要在我们的sop chain里面把它创建出来在哪呢就在创建depth image的后面啊这个函数呢是在这个sop chain的构建函数里面，ok在这里啊我们创建multi sample image，怎么创建呢首先我们要把猫这三方的这个数组resize一下变成m啊叫做image count这么多个随后呢我们循环，呃m image count四啊循环这么多次然后再加i好，在这里面我们需要对它的每一个进行创建的操作等于image create render target image好那么传进来的参数都有谁呢首先肯定少不了device，其次呢就是这边我也做一下处理啊，其次呢就是我们的s的长和宽啊长和宽诶这地儿，好把这个拿进来，然后呢我们green st arctic image还缺少一个东西对吧这边是错误啊缺少一个参数我们上节课预留的一个参数是什么来着s option应该是它的format啊就这张图片是什么格式它是rgb rgb a还是个什么东西啊，好那么我们创建完一张图片我们就要对它进行格式上的转换把它转换到适合用于attachment输出的最优格式那么我们就需要做一个region把这个region我们把它copy下来在这里给它弄一份，没的马有第三泡，好这边它的aspect就是vk image aspect的color beat了因为它是用于为用于输出颜色的接下来我们就要在这边啊对每一张图片进行一次格式上的转换set image lay，好把这些参数拷贝下来看看要改哪些第一个我的目标格式目标的layout啊不是格式啊目标的layout应该是image image layout，然后color attachment optimal啊就是用于输出颜色最优的我想把它转换成这样那么转换的起始阶段我会等待这个阶段完成对吧这个阶段，啊那么这就是管线最开始的阶段也就是说在这里面的一个command buffer一开始执行就是这个东西那么我希望在什么阶段去等待呢，什么阶段去等待它完成呢那么一定是pipeline来我们挑一个阶段stage呃attachment叫做stage color attachment output我希望就是说像这张图片上输出colour的这个阶段你必须等它的什么呀转换完成，才可以啊okay那么这个东西我们就做完了，呃做完之后呢我们再一件事我们这家伙呀他已经是multi sample了对吧为什么呢是因为在这里create的时候我们是不是已经给它加了这个device get more max multi sample对吧count，但是啊我们的，这张深度它并没有什么奥迪三炮的为什么深度也要做成么奥迪三炮的呢我们之前讲理论的时候啊给大家说过啊说我们在一个像素上要取四个采样点，那么是不是也要为它的每一个采样点记录它的深度信息啊对吧深度信息也要记录成四次你这样的话每一个采样得覆盖谁这个关系才能明确你才能知道这个采样点最终输出的颜色它到底是什么？
然后才能把四个采样点平均出来对吧好所以在这个创建depth image的时候我们也要去这么做，呃诶我们看一下啊，在这边创建的时候我们没有给到x image没有给到它这有一个参数我们现在给它补上sample account fab its，三号然后呢我们再去到image里面我们给它把这个事补上image image，这边呃看一下这边，vk sample count damping samples,好然后在这个地方不是一了r十二三post，ok这就可以了然后呢我们回到我们刚才的sub chain里面在这边啊创建深度的时候呢我们给它device get max一下，ok这样的话呢我们的深度就可以做多重采样了那么下来我们就要开始把这一堆东西啊我们现在为s创建出来了三张纸啊全部都要塞到frame buffer里面，这个地方在frame buffer里面呢我们可以看到这边有一个数组它打包原来s up ption自己自动创建的这张图片和我们depth depth这张图片，我们现在呀来排一个序啊在这个地方呢一定要注意顺序注意数组当中的顺序这是很重要的啊然后呢它必须与render pass啊要匹配，那么我们在一会儿呢会去改render pass就能看到了此时我们给它改成三个数组啊数组是三个元素第零个位置是我们最终要显示到屏幕上的这张图片第一个位置是multi sample的images加一个，那么在这个位置上小盖子里面这个右下，那么颜色会先被输送到这边再解决到这张图片上就能显示出来了对吧用它向它进行采样啊好，我们现在呢做完了这一系列的工作啊接下来呢就可以去啊去到我们的application看一看了那这边呢我们有一个函数是printer in the pass在里面设置了很多东西你像这张图片是什么呀这张图片原来是一个color attachment对吧，然后这个是一个缓深度缓存的touch ment那么两个描述我们给它加进去了我们现在啊具体一下这是零号位，对吧零号位我们写在这吧对写在这里啊，零号位是谁啊零号位是最终啊最终输出图片一号位是谁呢一号位是我们的resolve，图片也就是说我们的multi sample这张片然后我们二号位是depth这张图片好我们先看一下零号位这张图片这张图片是呃最终输出对吧零号位，最终输出，那么这张图片我们不需要改动啊它就这样就可以了三号呃就是持续的这个这样的一个三号就可以因为呢这套的意思是说别人从他身上啊怎么去采样的问题，ok啊ok在这里纠正一个语言上的错误啊这个零号位啊它是我们我们在这里多写点东西啊这个零号位是swap chain，原来那张图片啊图片是resolve的目标点也记啊记需要设置到sub pass的resolve当中啊在这里我们明确一下这件事儿啊一会儿呢，咱们要把这个东西啊它所对应的reference给设置到sub pass当中啊好这是最终输出图片然后呢被resolve的那张图片我们需要把它的test也写出来啊，那么我们去看一下，这边我们再加上，这边okay啊一号位，那么一号位是什么呢是啊resolved被resolved图片即多重采样的目标呃多重采样的啊这个源头图片，野禁，颜色输出的目标图片啊这个是我们的管线把颜色先放到这玩意上边再给它解决到这张图片上好我们给它取名叫做attachment叫做，mountain attachments,然后呢对它进行一番设置，这边的话呢它的采样啊就比，对吧它采样就是问题了应该是多少呢应该是m device get max这个因为这张图片是作为源头所以会被上面这张图片采样那么向它身上采样的时候你要做多少重的采样呢它的采样系数是多少呢就是这个，啊就是这一个ok那么它的final layout就不应该是present了因为它并不是用于输出对吧它不并不是用于输出啊它是用于image layout，color attachment optimal它是作为一个color attachment而存在的最终把它压入到这里边这是我们一号位啊最后是我们的，三号位就是深度缓存深度缓存这边呢这个也要给它改一改了device，get max,ok这边不需要多说对吧因为device也需要是作为一个源头啊被就是说被这家伙使用被一伙使用的啊ok那么我们再对比一下啊我们再检查一下看有没有出错里面的话呢，它的零号位是我们的目标啊被贴出去的目标一号位呢就是我们的多重采样的一张不源头图片这个呢就是ls啊没啥问题好我们回到这个开始我们继续做这件事儿，我们接下来要对它做一次的这样一个text ment上面的描述啊此时，attachments s呃我们现在有普通的这个是目标的就是被解决到哪张图片呢被解决到零号位对吧被解决到零号位，n第二个位置呢放的是什么其实是这样一个，那么在这边呢我们先对它的名字进行一下规范啊首先呢是它的这一个是目标嗯我们称它为attachment reference就是叫做呃，怎么说呢，这个叫做final attachment reference那最终会把它搞到这上面去啊呃final ok final再想一想啊零号位是原来那张图片没问题然后是一号位啊这边是一号位，一号位的话呢应该是我们的叫做multi attachment reference啊，好那么它的layout我们也是要求啊希望它输入的时候已经变成了这样的layout对吧输入的时候啊有有同学可能迷惑啊就是说上面啊为什么final它它的这个希望它输入的时候是这样呢因为它输入的时候啊它目前，还没有被去用来用来显示啊它是被用来把这张图片上面的东西resolve到它上面去所以它仍然是希望它作为color dash ment optimal在颜色已经画到这张图片上之后它才会被用于present所以它才会要转到present的最优格式，这个道理好最后是这个啊也没有啥问题了创建子流程接下来看add color attachment reference啊这边的话呢应该是，final dash ment reference对吧然后呢set depth然后我们这边也应该有一个东西能够给这个s pass去设置它的resolved对吧resolved我们现在重新排布一下这些东西啊重新排布一下，我们先去到sub house里面加一个函数啊，for accept叫做multi啊一个叫resolved attachment reference，life reference life reference,好复制一下然后去到这边，帽子拿下来，然后呢我们要加一个变量，这个变量呢是，resolved attachment reference是吧resolved reference然后我们再回来把resolved attachment reference设置成诶，别错了啊resolved attachment reference设置成当前这个reference这样就可以了然后呢我们要在build它的时候把这个resolve的东西给它设置进去，ever pass,description它的叫做pre solved，诶这attachment等于取个地址叫做resolved attachment reference okay我们看看一看它需不需要设置数量呢，嗯伪造的是不需要设置数量的啊ok那么我们就设置完毕了啊设置完毕了我们接下来在外边去排布一下排一排看一看啊嗯在排布之前我们还是复习一个点，呃那么复习的点就是attachment ok啊不需要复习这个点了它它们都是不一样的attachment的类型啊回到这个里面二的话呢应该是谁啊color point是final了对不对color应该是我们的multi，attachment reference首先颜色会输出到它上面去然后呢depth会输出到它上面去然后呢sub pass从被resolve到set resolve这上面呢会被resolve到啊就我们的这个final attachment reference上面，被解决到它上面去最终b五的这个saddle pass然后我们再往下看子流程依赖没有问题这边呢有没有问题呢也没有问题右边没有问题啊，我们看再再检查一遍啊那个什么呢再检查一遍这个render pass的attachment它们到底都放进去了首先零号位放的是这个啊final没有问题那边我们把名字改了吧，i know attachment description,ok这样就是final那张result那张depth那张都已经放进去了也是没有问题了啊好那么我们现在啊来编译一下跑一跑啊先清理，看有什么问题，ok出现了一些问题看一下哦cannot call description pool哎看一下上面有很多问题大家可能看不清楚啊这边我暂停一下看看问题然后给大家讲好我们先来修改几个问题啊刚才问题还蛮多的，第一个问题是创建market sample images的时候啊这边呢我们用了一个格式转换这个region我们没有给它替换过来啊这个地方，region需要替换成这个就马三跑啊然后第二个问题呢在application这里边啊这个关于depths reference depths reference这边的话呢我们应该给它一个二位啊给它个二号位ok再跑一下啊可能还会有错误有错误我们再看看还有什么啊，诶还有一些错误这个再读一读ok那么问题也找到了啊其实呢是在我们的pipeline设置的时候就又一个问题了好我们现在总结一下就是出现了几个问题啊一个问题就是之前在s里面，呃这个region没有设置好第二个的话呢在application的create or past的时候啊咱们那个dex的reference没设置好然后第三个问题呢就是这边啊这边的话呢唉多重采样这边我们就不用to do了再，pipeline设置sample state的时候这个地方啊就是它resurrection samples需要给它规定好要做device get，max ok再给它设置进去啊然后呢接下来还有一个地方就是在great runner pass呃看一下是不是这边啊不是啊在，这里啊这个地方是application great command buffers就是在我们最终输入到啊最终输入到咱们这个版型当中进行渲染的这一方啊，这边有个clear color我们只规定了第一个buffer的color和第二个buffer的color对吧这个是用于深度的清理颜色这个是用于颜这个resolve的那张图片啊也就是说那张我们在这标识一下啊，当然零号位是目标啊是final然后一号位我们是multi二号位是我们的abs好我们给它归定上，然后规定完了之后呢我们就按照这个规定来走吧，这个呢是clear colors啊ok我们给它取名叫final clear colors，然后呢设置进去啊诶不对啊这个写错了呃应该是这个啊这个是final clear colors，final clear color然后设置一下给它推入到管下推入到数组然后第二个位置我们给它取名叫做，呃马武器肯定要color，然后也设置一下颜色再退到数组里面第三个位置啊诶这里有一个啊，呃看一下depth，好第三个位置是defs格调color然后给它设置了推入啊这三个都推入了没问题然后我们再跑一下，诶这就出来了啊我们放大看一下啊放大看边缘啊不知道大家能不能从自己的电脑上看清楚啊视频能不能看清楚我这边看到的呢是这边的边缘已经非常顺滑大家看啊这边的边非常的顺滑，呃完全没有任何的锯齿就是我们人眼是看不到什么锯齿了ok那么这节课的内容就到这里，
